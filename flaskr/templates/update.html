{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Edit "{{ post['title'] }}"{% endblock %}</h1>
{% endblock %}

{% block content %}
  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <label for="title">Title</label>
    <input name="title" id="title"
      value="{{ request.form['title'] or post['title'] }}" required>
    <label for="body">Body</label>
    <textarea name="body" id="body">{{ request.form['body'] or post['body'] }}</textarea>
    <select name="status" id="status" required>
      <option value="investigating" {% if (request.form['status'] or post['status']) == 'investigating' %}selected{% endif %}>Investigating</option>
      <option value="resolved" {% if (request.form['status'] or post['status']) == 'resolved' %}selected{% endif %}>Resolved</option>
    </select>

    {% if post['updates'] %}
      <hr>
      <h2>Updates</h2>
      {% for update in post['updates'] %}
        <div class="update">
          <label for="update_body_{{ update['update_id'] }}">Update Text</label>
          <textarea name="update_body_{{ update['update_id'] }}" id="update_body_{{ update['update_id'] }}">{{ request.form['update_body_' ~ update['update_id']] or update['update_content'] }}</textarea>
          <button type="button" class="delete-update-btn" data-update-id="{{ update['update_id'] }}">Delete</button>
        </div>
      {% endfor %}
    {% endif %}

    {% if do_update %}
      <hr>
      <h2>Add New Update</h2>
      <label for="new_update_body">Update Text</label>
      <textarea name="new_update_body" id="new_update_body">{{ request.form['new_update_body'] }}</textarea>
    {% endif %}

    <input type="submit" value="Save">
  </form>

  {% if not do_update %}
    <a class="action" href="{{ url_for('status.edit', id=post['id'], do_update='true') }}">Add Update</a>
  {% endif %}

  <hr>
  <form action="{{ url_for('status.delete', id=post['id']) }}" method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input class="danger" type="submit" value="Delete" onclick="return confirm('Are you sure?');">
  </form>
{% endblock %}

{% block script %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.delete-update-btn').forEach(button => {
        button.addEventListener('click', function() {
          const updateId = this.dataset.updateId;
          const postId = {{ post['id'] }};
          if (confirm('Are you sure you want to delete this update?')) {
            fetch(`/${postId}/update/${updateId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'  // Ensure you have CSRF protection
              },
              body: JSON.stringify({ _method: 'DELETE' })
            }).then(response => {
              if (response.ok) {
                location.reload();
              } else {
                alert('Failed to delete the update.');
              }
            });
          }
        });
      });
    });
  </script>
{% endblock %}
